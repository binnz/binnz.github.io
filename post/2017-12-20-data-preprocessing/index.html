<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Data Preprocessing and Exploring the New York City Bike Dataset - California Dreaming</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
  
  <meta name="description" content="In this report, I will   do   some   data   preprocessing and   then   get   some   basic information   about   the   dataset, New   York   Citi   Bike   Trip   Histories,    via   tools.">
  
  <meta itemprop="name" content="Data Preprocessing and Exploring the New York City Bike Dataset - California Dreaming">
  <meta itemprop="description" content="In this report, I will   do   some   data   preprocessing and   then   get   some   basic information   about   the   dataset, New   York   Citi   Bike   Trip   Histories,    via   tools.">
  <meta itemprop="image" content="https://binnz.github.io/img/author.jpg">
  
  
  <meta name="twitter:description" content="">
  
  <link rel="shortcut icon" href="https://binnz.github.io/img/favicon.ico"/>
  <link rel="apple-touch-icon" href="https://binnz.github.io/apple-touch-icon.png" />
  <link rel="apple-touch-icon-precomposed" href="https://binnz.github.io/apple-touch-icon.png" />
  <link rel="stylesheet" href="https://binnz.github.io/highlight/styles/github.css">
  <script src="https://binnz.github.io/highlight/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  <link rel="stylesheet" href="https://binnz.github.io/font/hack/css/hack.min.css">
  <link rel="stylesheet" href="https://binnz.github.io/css/style.css">
</head>

<body>
  <header>
    <div>
  <div style="height:150px; width:100%; clear:both;"></div>
  <div id="textlogo">
    <h1 class="site-name"><a href="https://binnz.github.io/" title="California Dreaming">California Dreaming</a></h1>
    <h2 class="blog-motto"></h2>
  </div>
  <div class="navbar"><a class="navbutton navmobile" href="#" title="menu"></a></div>
			<div style="height:50px; width:100%; clear:both;"></div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="menu">
			</a><div style="height:50px; width:100%; clear:both;"></div></div>
  <nav class="animated">
    <ul>
      
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/post/">Archives</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
      
      <li>
        <form class="search" method="get" action="https://www.google.com/search">
          <div>
            <input type="text" id="search" name="q" placeholder='Search'>
          </div>
        </form>
      </li>
    </ul>
  </nav>
</div>

  </header>
  <div id="container">
    <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody">
    <header class="article-info clearfix">
  <h1 itemprop="name">
      <a href="https://binnz.github.io/post/2017-12-20-data-preprocessing/" title="Data Preprocessing and Exploring the New York City Bike Dataset" itemprop="url">Data Preprocessing and Exploring the New York City Bike Dataset</a>
  </h1>
  <p class="article-author">By
    
      <a href="" title="">you</a>
    
  </p>
  <p class="article-time">
    <time datetime="2017-12-20 00:00:00 &#43;0000 UTC" itemprop="datePublished">2017-12-20</time>
  </p>
</header>

	<div class="article-content">
    
    <p>In this report, I will   do   some   data   preprocessing and   then   get   some   basic information   about   the   dataset, <a href="https://www.citibikenyc.com/system-data">New   York   Citi   Bike   Trip   Histories</a>,    via   tools.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.basemap</span> <span class="kn">import</span> <span class="n">Basemap</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span> <span class="nn">geopy.distance</span> <span class="kn">import</span> <span class="n">vincenty</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">linear_model</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="dataset">Dataset</h2>
<p>Here we&rsquo;ll   use   <a href="https://s3.amazonaws.com/tripdata/201707-citibike-tripdata.csv.zip"><code>201707-citibike-tripdata.csv.zip</code></a>   only.</p>
<h3 id="schema">Schema</h3>
<p>The data includes:</p>
<ul>
<li>Trip Duration (seconds)</li>
<li>Start Time and Date</li>
<li>Stop Time and Date</li>
<li>Start Station Name</li>
<li>End Station Name</li>
<li>Station ID</li>
<li>Station Lat/Long</li>
<li>Bike ID</li>
<li>User Type (<code>Customer</code> = 24-hour pass or 3-day pass user; <code>Subscriber</code> = Annual Member)</li>
<li>Gender (<code>Zero</code>=unknown; <code>1</code>=male; <code>2</code>=female)</li>
<li>Year of Birth</li>
</ul>
<p>This data has been processed to remove trips that are taken by staff as they service and inspect the system, trips that are taken to/from any of our “test” stations (which we were using more in June and July 2013), and any trips that were below 60 seconds in length (potentially false starts or users trying to re-dock a bike to ensure it&rsquo;s secure).</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s2">&#34;https://s3.amazonaws.com/tripdata/201707-citibike-tripdata.csv.zip&#34;</span><span class="p">,</span> <span class="s2">&#34;data.zip&#34;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&#34;data.zip&#34;</span><span class="p">,</span><span class="s2">&#34;r&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_ref</span><span class="p">:</span>
    <span class="n">zip_ref</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="s2">&#34;./data&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">walk</span>

<span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="s2">&#34;./data&#34;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>['201707-citibike-tripdata.csv']
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&#34;./data/201707-citibike-tripdata.csv&#34;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }
<pre><code>.dataframe thead th {
    text-align: left;
}

.dataframe tbody tr th {
    vertical-align: top;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>tripduration</th>
      <th>starttime</th>
      <th>stoptime</th>
      <th>start station id</th>
      <th>start station name</th>
      <th>start station latitude</th>
      <th>start station longitude</th>
      <th>end station id</th>
      <th>end station name</th>
      <th>end station latitude</th>
      <th>end station longitude</th>
      <th>bikeid</th>
      <th>usertype</th>
      <th>birth year</th>
      <th>gender</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>364</td>
      <td>2017-07-01 00:00:00</td>
      <td>2017-07-01 00:06:05</td>
      <td>539</td>
      <td>Metropolitan Ave &amp; Bedford Ave</td>
      <td>40.715348</td>
      <td>-73.960241</td>
      <td>3107</td>
      <td>Bedford Ave &amp; Nassau Ave</td>
      <td>40.723117</td>
      <td>-73.952123</td>
      <td>14744</td>
      <td>Subscriber</td>
      <td>1986.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2142</td>
      <td>2017-07-01 00:00:03</td>
      <td>2017-07-01 00:35:46</td>
      <td>293</td>
      <td>Lafayette St &amp; E 8 St</td>
      <td>40.730207</td>
      <td>-73.991026</td>
      <td>3425</td>
      <td>2 Ave  &amp; E 104 St</td>
      <td>40.789210</td>
      <td>-73.943708</td>
      <td>19587</td>
      <td>Subscriber</td>
      <td>1981.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>328</td>
      <td>2017-07-01 00:00:08</td>
      <td>2017-07-01 00:05:37</td>
      <td>3242</td>
      <td>Schermerhorn St &amp; Court St</td>
      <td>40.691029</td>
      <td>-73.991834</td>
      <td>3397</td>
      <td>Court St &amp; Nelson St</td>
      <td>40.676395</td>
      <td>-73.998699</td>
      <td>27937</td>
      <td>Subscriber</td>
      <td>1984.0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2530</td>
      <td>2017-07-01 00:00:11</td>
      <td>2017-07-01 00:42:22</td>
      <td>2002</td>
      <td>Wythe Ave &amp; Metropolitan Ave</td>
      <td>40.716887</td>
      <td>-73.963198</td>
      <td>398</td>
      <td>Atlantic Ave &amp; Furman St</td>
      <td>40.691652</td>
      <td>-73.999979</td>
      <td>26066</td>
      <td>Subscriber</td>
      <td>1985.0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2534</td>
      <td>2017-07-01 00:00:15</td>
      <td>2017-07-01 00:42:29</td>
      <td>2002</td>
      <td>Wythe Ave &amp; Metropolitan Ave</td>
      <td>40.716887</td>
      <td>-73.963198</td>
      <td>398</td>
      <td>Atlantic Ave &amp; Furman St</td>
      <td>40.691652</td>
      <td>-73.999979</td>
      <td>29408</td>
      <td>Subscriber</td>
      <td>1982.0</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1735599 entries, 0 to 1735598
Data columns (total 15 columns):
tripduration               int64
starttime                  object
stoptime                   object
start station id           int64
start station name         object
start station latitude     float64
start station longitude    float64
end station id             int64
end station name           object
end station latitude       float64
end station longitude      float64
bikeid                     int64
usertype                   object
birth year                 float64
gender                     int64
dtypes: float64(5), int64(5), object(5)
memory usage: 198.6+ MB
</code></pre>
<h2 id="preprocess">Preprocess</h2>
<h3 id="missing-values--anomaly-detection">Missing Values &amp; Anomaly Detection</h3>
<p>There might be some noise in the dataset, like strange stations or null values.   Please detect it and take   proper actions to them.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>(1735599, 15)
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>tripduration                    0
starttime                       0
stoptime                        0
start station id                0
start station name              0
start station latitude          0
start station longitude         0
end station id                  0
end station name                0
end station latitude            0
end station longitude           0
bikeid                          0
usertype                        0
birth year                 228596
gender                          0
dtype: int64
</code></pre>
<p>The data is clean that we can simply drop the column <code>&quot;birth year&quot;</code> since we are not going to use this feature anyway.</p>
<p>Here I ues the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.dropna.html"><strong><code>dropna</code></strong></a> function to drop <em>any</em> columns with <em>any</em> missing values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>(1735599, 14)
</code></pre>
<p>Next, to detect and eliminate strange values, we plot all the histograms on numeric values.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>

<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span> <span class="ow">or</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="s2">&#34; (log scale)&#34;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/qyS8osn.png" alt=""></p>
<p>There are some values that are strange:</p>
<ol>
<li>The maximum value of trip duration is <code>2500000 sec(s)</code>, which is about <code>28</code> days.   This is very uncommon for a person to rent a citibike for such a long time.</li>
<li>There is a station that is so far away from other stations. (See the rightmost balue of end station latitude/longitude.)</li>
</ol>
<p>Here I would deal with the first problem by removing any records whose <code>trip duration</code> is over <code>20</code> days.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;trip duration&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">20</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>Now we check if all stations have one-to-one matching among their <code>id</code>, <code>name</code>, <code>latitude</code>, and <code>longitude</code>.</p>
<ul>
<li><code>station id</code> &lt;&mdash;&gt; <code>station name</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">x1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;start station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start station name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">x2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;end station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

<span class="n">x1</span> <span class="o">==</span> <span class="n">y1</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">y2</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>True
</code></pre>
<ul>
<li><code>station id</code> &lt;&mdash;&gt; <code>station latitude</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">x1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;start station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start station latitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">x2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;end station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station latitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

<span class="n">x1</span> <span class="o">==</span> <span class="n">y1</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">y2</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>True
</code></pre>
<ul>
<li><code>station id</code> &lt;&mdash;&gt; <code>station longitude</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">x1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;start station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start station longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>
<span class="n">x2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;end station id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">y2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station longitude&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">())</span>

<span class="n">x1</span> <span class="o">==</span> <span class="n">y1</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">==</span> <span class="n">y2</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>True
</code></pre>
<p>We can also draw all stations on map to see if there is any strange location</p>
<p>Here I use the <a href="https://matplotlib.org/basemap/api/basemap_api.html"><strong><code>Basemap</code></strong></a> package of <code>matplotlib</code> to draw the map. (See examples <a href="https://matplotlib.org/basemap/users/geography.html">here</a>)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">t1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start station name&#39;</span><span class="p">,</span> <span class="s1">&#39;start station latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;start station longitude&#39;</span><span class="p">]]</span> \
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;start station id&#39;</span><span class="p">:</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> \
                                                 <span class="s1">&#39;start station name&#39;</span><span class="p">:</span><span class="s1">&#39;station name&#39;</span><span class="p">,</span> \
                                                 <span class="s1">&#39;start station latitude&#39;</span><span class="p">:</span><span class="s1">&#39;station latitude&#39;</span><span class="p">,</span> 
                                                 <span class="s1">&#39;start station longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;station longitude&#39;</span><span class="p">})</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station name&#39;</span><span class="p">,</span> <span class="s1">&#39;end station latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;end station longitude&#39;</span><span class="p">]]</span> \
        <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;end station id&#39;</span><span class="p">:</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> \
                                             <span class="s1">&#39;end station name&#39;</span><span class="p">:</span><span class="s1">&#39;station name&#39;</span><span class="p">,</span> \
                                             <span class="s1">&#39;end station latitude&#39;</span><span class="p">:</span><span class="s1">&#39;station latitude&#39;</span><span class="p">,</span> \
                                             <span class="s1">&#39;end station longitude&#39;</span><span class="p">:</span> <span class="s1">&#39;station longitude&#39;</span><span class="p">})</span>
<span class="n">df_loc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Initialize plots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>

<span class="c1"># determine range to print based on min, max lat and lon of the data</span>
<span class="n">lat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;station latitude&#39;</span><span class="p">])</span>
<span class="n">lon</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;station longitude&#39;</span><span class="p">])</span>
<span class="n">text</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">])</span>
<span class="n">margin</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># buffer to add to the range</span>
<span class="n">lat_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
<span class="n">lat_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin</span>
<span class="n">lon_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
<span class="n">lon_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin</span>

<span class="c1"># create map using BASEMAP</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="n">lon_min</span><span class="p">,</span>
            <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">lat_min</span><span class="p">,</span>
            <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">lon_max</span><span class="p">,</span>
            <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">lat_max</span><span class="p">,</span>
            <span class="n">lat_0</span><span class="o">=</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">lon_0</span><span class="o">=</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;lcc&#39;</span><span class="p">,</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span><span class="p">,)</span>

<span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">fillcontinents</span><span class="p">(</span><span class="n">lake_color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawmapboundary</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">drawrivers</span><span class="p">()</span>

<span class="c1"># convert lat and lon to map projection coordinates</span>
<span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

<span class="c1"># plot points as red dots</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_loc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/PxJ76Iy.png" alt=""></p>
<p>The station &ldquo;<code>3254</code>&rdquo; and &ldquo;<code>3182</code>&rdquo; seems weird, however, these 2 stations are actually on an island named &ldquo;Governors Island&rdquo;.</p>
<p>And the station &ldquo;<code>3036</code>&rdquo;, which is at the upper-right corner of the map, <strong>does not exist</strong> actually, whereas station &ldquo;<code>3201</code>&rdquo; and &ldquo;<code>3192</code>&rdquo; are confirmed to exist.</p>
<p>(The way that I confirm the above information is to check the <a href="http://www.citibikenyc.com/stations/json">station list on the official website</a> &amp; <a href="https://www.google.com.tw/maps/search/Citi+Bike/@40.7318011,-74.0213749,13z/data=!3m1!4b1">Googe Map</a>.)</p>
<p>So we need to <strong>remove</strong> data related to this station.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;start station id&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">3036</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;end station id&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">3036</span><span class="p">]</span>
<span class="n">df_loc</span> <span class="o">=</span> <span class="n">df_loc</span><span class="p">[</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]</span><span class="o">!=</span><span class="mi">3036</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">df_loc</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&#34;data/station_information.csv&#34;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>So now I want to check if all station ids mentioned in this dataframe exists.</p>
<h3 id="create-self-defined-features">Create Self-defined Features</h3>
<p>For future use, we need to calculate in-flow and out-flow for each stations every half hour.   The result data set should contains <code>station_id</code>, <code>time</code>, <code>in_flow_count</code>, <code>out_flow_count</code>.</p>
<blockquote>
<p><strong>in/out flow of a station</strong> are define as the number of trips move to/from the station within the 30 minutes period.
So one day can be splitted into 48 segments.</p>
</blockquote>
<p>To split one day into 48 segemnts, first we need to transform column <code>&quot;starttime&quot;</code> and <code>&quot;stoptime&quot;</code> into <code>datetime</code> format.
(Use the <a href="http://pandas.pydata.org/pandas-docs/version/0.20/generated/pandas.to_datetime.html"><code>to_datetime</code></a> function, specifying a <a href="http://strftime.org/">format</a> to match the data.)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># format example: 2017-07-01 00:00:00</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;stoptime&#39;</span><span class="p">]</span> <span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;stoptime&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 1735598 entries, 0 to 1735598
Data columns (total 14 columns):
tripduration               int64
starttime                  datetime64[ns]
stoptime                   datetime64[ns]
start station id           int64
start station name         object
start station latitude     float64
start station longitude    float64
end station id             int64
end station name           object
end station latitude       float64
end station longitude      float64
bikeid                     int64
usertype                   object
gender                     int64
dtypes: datetime64[ns](2), float64(4), int64(5), object(3)
memory usage: 198.6+ MB
</code></pre>
<p>Now we need to <strong>annotate</strong> the data according to time segment: (Use <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DatetimeIndex.html"><code>DatetimeIndex</code></a> to retrieve date&amp;time information)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">gen_time_segment</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
        <span class="n">minute</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%02d</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minute</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">%02d</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="mi">30</span>
    <span class="k">return</span> <span class="s2">&#34;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;start_seg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen_time_segment</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;stop_seg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen_time_segment</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;stoptime&#39;</span><span class="p">]]</span>

<span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">,</span> <span class="s1">&#39;start_seg&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;stoptime&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_seg&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }
<pre><code>.dataframe thead th {
    text-align: left;
}

.dataframe tbody tr th {
    vertical-align: top;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start station id</th>
      <th>starttime</th>
      <th>start_seg</th>
      <th>end station id</th>
      <th>stoptime</th>
      <th>stop_seg</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>539</td>
      <td>2017-07-01 00:00:00</td>
      <td>2017-7-1 0:00</td>
      <td>3107</td>
      <td>2017-07-01 00:06:05</td>
      <td>2017-7-1 0:00</td>
    </tr>
    <tr>
      <th>1</th>
      <td>293</td>
      <td>2017-07-01 00:00:03</td>
      <td>2017-7-1 0:00</td>
      <td>3425</td>
      <td>2017-07-01 00:35:46</td>
      <td>2017-7-1 0:30</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3242</td>
      <td>2017-07-01 00:00:08</td>
      <td>2017-7-1 0:00</td>
      <td>3397</td>
      <td>2017-07-01 00:05:37</td>
      <td>2017-7-1 0:00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2002</td>
      <td>2017-07-01 00:00:11</td>
      <td>2017-7-1 0:00</td>
      <td>398</td>
      <td>2017-07-01 00:42:22</td>
      <td>2017-7-1 0:30</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2002</td>
      <td>2017-07-01 00:00:15</td>
      <td>2017-7-1 0:00</td>
      <td>398</td>
      <td>2017-07-01 00:42:29</td>
      <td>2017-7-1 0:30</td>
    </tr>
  </tbody>
</table>
</div>
<p>Then <strong>group</strong> and <strong>count</strong> the data according to time annotations:</p>
<ul>
<li><code>in-flow</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">inflow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_seg&#39;</span><span class="p">]]</span> \
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;end station id&#39;</span><span class="p">,</span> <span class="s1">&#39;stop_seg&#39;</span><span class="p">])</span> \
            <span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;end station id&#39;</span><span class="p">:</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span><span class="s1">&#39;stop_seg&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>out-flow</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">outflow</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start_seg&#39;</span><span class="p">]]</span> \
            <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;start_seg&#39;</span><span class="p">])</span> \
            <span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;start station id&#39;</span><span class="p">:</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span><span class="s1">&#39;start_seg&#39;</span><span class="p">:</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;counts&#39;</span><span class="p">:</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>In the end, <strong>merge</strong> the <code>inflow</code> and <code>outflow</code> dataframes, considering <strong>every time segment at every station</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">station_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_loc</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">])</span>

<span class="c1"># Create combinations of time series and station ids</span>
<span class="n">time_seg_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s2">&#34;2017-07-01 00:00:00&#34;</span><span class="p">,</span> <span class="s2">&#34;2017-07-31 23:30:00&#34;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&#34;30min&#34;</span><span class="p">))</span>
<span class="n">template</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">station_id_list</span><span class="p">,</span> <span class="n">time_seg_list</span><span class="p">)),</span> \
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;station id&#34;</span><span class="p">,</span> <span class="s2">&#34;time&#34;</span><span class="p">])</span>

<span class="c1"># Merge in/out flow information &amp; Add zeros to missing data according to every time segment</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inflow</span><span class="p">,</span> <span class="n">outflow</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
<span class="n">dat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
<span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;station id&#34;</span><span class="p">,</span> <span class="s2">&#34;time&#34;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&#34;right&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dat</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }
<pre><code>.dataframe thead th {
    text-align: left;
}

.dataframe tbody tr th {
    vertical-align: top;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>station id</th>
      <th>time</th>
      <th>in_flow_count</th>
      <th>out_flow_count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>72</td>
      <td>2017-07-01 00:00:00</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>72</td>
      <td>2017-07-01 10:00:00</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>72</td>
      <td>2017-07-01 10:30:00</td>
      <td>7.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>72</td>
      <td>2017-07-01 11:00:00</td>
      <td>1.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>72</td>
      <td>2017-07-01 12:00:00</td>
      <td>2.0</td>
      <td>6.0</td>
    </tr>
  </tbody>
</table>
</div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dat</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s2">&#34;data/station_flow.csv&#34;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="query">Query</h2>
<h3 id="how--many--stations--are--there--in--this--datasetand--what--is--the--average-distance---between---them">How  many  stations  are  there  in  this  dataset,and  what  is  the  average distance   between   them?</h3>
<p>$$
average~distance = \frac {\sum_{i!=j} dist(S_i,S_j)}{\frac{N(N-1)}{2}}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{}</span><span class="s2"> stations are found in this dataset.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">station_id_list</span><span class="p">)))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>633 stations are found in this dataset.
</code></pre>
<p>To calculate the distance between stations, I use the function <a href="https://geopy.readthedocs.io/en/1.10.0/#module-geopy.distance"><strong><code>vincenty</code></strong></a> in package <code>GeoPy</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Create dictionaries for station latitude/longitude</span>
<span class="n">lat_dic</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">lon_dic</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_loc</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">lat_dic</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;station latitude&#39;</span><span class="p">]</span>
    <span class="n">lon_dic</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;station longitude&#39;</span><span class="p">]</span>

<span class="c1"># Generate combinations of pairs of station</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">station_id_list</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Calculate the averge distance of pairs of stations</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">stn1</span><span class="p">,</span> <span class="n">stn2</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">dist</span> <span class="o">+=</span> <span class="n">vincenty</span><span class="p">((</span><span class="n">lat_dic</span><span class="p">[</span><span class="n">stn1</span><span class="p">],</span> <span class="n">lon_dic</span><span class="p">[</span><span class="n">stn1</span><span class="p">]),</span> <span class="p">(</span><span class="n">lat_dic</span><span class="p">[</span><span class="n">stn2</span><span class="p">],</span> <span class="n">lon_dic</span><span class="p">[</span><span class="n">stn2</span><span class="p">]))</span><span class="o">.</span><span class="n">meters</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The average distance between different stations is </span><span class="si">{}</span><span class="s2"> (meters)&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="o">/</span><span class="n">count</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The average distance between different stations is 5393.467456938468 (meters)
</code></pre>
<h3 id="what--are--the--top--3--frequent--stations--pairs-start-station-end-station--in-weekdays-how---about---in---weekends">What  are  the  top  3  frequent  stations  pairs <code>(start station, end station)</code>  in weekdays, how   about   in   weekends?</h3>
<p>$$
(S_i,S_j)~is~not~(S_j,S_i)
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Split the dataframe into weekdays information &amp; weekends information</span>
<span class="n">df_weekdays</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">df_weekends</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">]</span>

<span class="c1"># Count and sort station pair frequencies</span>
<span class="n">stn_pair_weekdays</span> <span class="o">=</span> <span class="n">df_weekdays</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">]]</span> \
                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">])</span> \
                    <span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">])</span> \
                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">stn_pair_weekends</span> <span class="o">=</span> <span class="n">df_weekends</span><span class="p">[[</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">]]</span> \
                    <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">])</span> \
                    <span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">)</span> \
                    <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;start station id&#39;</span><span class="p">,</span> <span class="s1">&#39;end station id&#39;</span><span class="p">])</span> \
                    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
<span class="c1"># Find the top 3 station pairs for weekday &amp; weekend</span>
<span class="n">top_weekday_pair</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stn_pair_weekdays</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">top_weekend_pair</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stn_pair_weekends</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Print out the result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The top 3 frequent stations pairs in weekdays are: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, and </span><span class="si">{}</span><span class="s2">.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">top_weekday_pair</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The top 3 frequent stations pairs in weekends are: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, and </span><span class="si">{}</span><span class="s2">.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">top_weekend_pair</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The top 3 frequent stations pairs in weekdays are: (432, 3263), (2006, 2006), and (281, 281).
The top 3 frequent stations pairs in weekends are: (3182, 3182), (3182, 3254), and (3254, 3182).
</code></pre>
<h3 id="find--the--top--3--stations--with--highest--average--out-flow-and--top--3--highest-average---in-flow">Find  the  top  3  stations  with  highest  average  <code>out-flow</code>, and  top  3  highest average   <code>in-flow</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Sort the average in/out flow count of each station</span>
<span class="n">average_inflow</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[[</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> <span class="s1">&#39;in_flow_count&#39;</span><span class="p">]]</span> \
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;station id&#39;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">mean</span><span class="p">()</span> \
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">average_outflow</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[[</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_count&#39;</span><span class="p">]]</span> \
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;station id&#39;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">mean</span><span class="p">()</span> \
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
<span class="c1"># List the top 3 stations</span>
<span class="n">top_inflow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">average_inflow</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">top_outflow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">average_outflow</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Print out the result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The top 3 stations with highest outflow are: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, and </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">top_outflow</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The top 3 stations with highest inflow are: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">, and </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">top_inflow</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The top 3 stations with highest outflow are: 519, 426, and 514
The top 3 stations with highest inflow are: 426, 519, and 514
</code></pre>
<h3 id="what--is--the--most--popular--stationhighest--average--inflowoutflow">What  is  the  most  popular  station(highest  average  inflow+outflow)?</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Sum up in/out flow at each time station</span>
<span class="n">dat</span><span class="p">[</span><span class="s1">&#39;flow_count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dat</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span>

<span class="c1"># Calculate and sort the average flow count for each station</span>
<span class="n">average_flow</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[[</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> <span class="s1">&#39;flow_count&#39;</span><span class="p">]]</span> \
                <span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;station id&#39;</span><span class="p">])</span> \
                <span class="o">.</span><span class="n">mean</span><span class="p">()</span> \
                <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;flow_count&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
<span class="c1"># Find the top 1 station</span>
<span class="n">top_flow</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">average_inflow</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

<span class="c1"># Print out the result</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The most popular station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">top_outflow</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The most popular station is: 519
</code></pre>
<h4 id="a-draw--the--in-flowa--and--out-flowb--for--that--station--in--a--line--chart">a. Draw  the  in-flow($A$)  and  out-flow($B$)  for  that  station  in  a  line  chart</h4>
<p>Here I use the <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.plot.html"><strong><code>plot</code></strong></a> function of <code>pandas</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Select station &amp; add information in missing time</span>
<span class="n">small_df</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[</span><span class="n">dat</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">519</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="n">small_df</span> <span class="o">=</span> <span class="n">small_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="c1"># Plot line chart</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_count&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/RRbXGzU.png" alt=""></p>
<h4 id="b-calculate--the--distance--function--between---a---and---b">b. Calculate  the  distance  function  between   $A$   and   $B$</h4>
<p>Here I use <a href="http://scikit-learn.org/stable/modules/generated/sklearn.metrics.pairwise.pairwise_distances.html"><strong><code>pairwise_distance</code></strong></a> of <code>scikit-learn</code>, with metrics as  &ldquo;euclidean distance&rdquo;.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dist</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">([</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The euclidean distance between in-flow and out-flow of this station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The euclidean distance between in-flow and out-flow of this station is: 178.5553135585721
</code></pre>
<h4 id="c-calculate---the---distance---function---between----a-meana----and-b-meanb--and---draw---them---both">c. Calculate   the   distance   function   between    $A-mean(A)$    and $B-mean(B)$ , and   draw   them   both.</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Substract the mean</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Plot line chart</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_flow_diff&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_diff&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/ix4ROU5.png" alt=""></p>
<p>Now calculate the euclidean distance between the in-flow and the out-flow again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dist</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">([</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_diff&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_diff&#39;</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The euclidean distance between in-flow and out-flow of this station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The euclidean distance between in-flow and out-flow of this station is: 178.27760158193377
</code></pre>
<h4 id="d-calculate--the--distance--function--between---a-meanastda-and----b-meanbstdb--and---draw---them---both">d. Calculate  the  distance  function  between   $(A-mean(A))/std(A)$ and    $(B-mean(B))/std(B)$ , and   draw   them   both.</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Calculate variance</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_diff&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_variance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_diff&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># Plot line chart</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_flow_variance&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_variance&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/caYFbvl.png" alt=""></p>
<p>Now calculate the euclidean distance between the in-flow and the out-flow again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dist</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">([</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_variance&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_variance&#39;</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The euclidean distance between in-flow and out-flow of this station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The euclidean distance between in-flow and out-flow of this station is: 12.27694023559983
</code></pre>
<h4 id="e-calculate--the--distance--function--between--a_ifia_i-in-a--and-b_i-fib_i-in-band--draw--them--both">e. Calculate  the  distance  function  between  ${A_i−f(i)|A_i \in A}$  and ${B_i −f(i)|B_i \in B}$,and  draw  them  both.</h4>
<p>$$
f~is~the~linear~function~that~minimize~\sum(A_i−f(i))^2
$$</p>
<p>First, we need to <strong>fit</strong> the linear regression models $f(i)$ for both $A$ and $B$, using <code>Linear Regression</code> in <a href="http://scikit-learn.org/stable/modules/linear_model.html#ordinary-least-squares">Generalized Linear Models</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Prepare input for linear regression model</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">length</span> <span class="o">=</span> <span class="n">small_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Create and fit the models</span>
<span class="n">reg_A</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">reg_A</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]))</span>
<span class="n">reg_B</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">reg_B</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]))</span>

<span class="c1"># Save the prediction results</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred_A</span> <span class="o">=</span> <span class="n">reg_A</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_linear&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred_B</span> <span class="o">=</span> <span class="n">reg_B</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

<span class="c1"># Plot the fit reuslt</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y_pred_A</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">y_pred_B</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/wOjdyQz.png" alt=""></p>
<p>Then we can calculate  ${A_i−f(i) | A_i \in A}$  and
${B_i −f(i) | B_i \in B}$, and  draw  them  both.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Calculate distance to the line drawn by linear model</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_ols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_linear&#39;</span><span class="p">]</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_ols&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_linear&#39;</span><span class="p">]</span>

<span class="c1"># Plot line chart</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_flow_ols&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_ols&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/jFoai85.png" alt=""></p>
<p>Now calculate the euclidean distance between the in-flow and the out-flow again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dist</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">([</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_ols&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_ols&#39;</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The euclidean distance between in-flow and out-flow of this station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The euclidean distance between in-flow and out-flow of this station is: 178.27208810218377
</code></pre>
<h4 id="f-calculate---the---distance---function---between----smootha----and-smoothb-and---draw---them---both">f. Calculate   the   distance   function   between    $Smooth(A)$    and $Smooth(B)$ ,and   draw   them   both.</h4>
<p>You   can   choose   any   smoothing   function,just   specify   it, or   simply   use</p>
<p>$$
A_i = \frac{A_{i−1}+A_i+A_{i+1}}{3}
$$</p>
<p>(or   take   the   average   of   5,7,9&hellip;   elements)</p>
<p>Here I use the function <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.rolling.html"><strong><code>rolling</code></strong></a> in <code>pandas</code> to take the <strong>average mean</strong>.</p>
<ul>
<li><strong><code>window = 9</code></strong>, as I take the average of 9 elements.</li>
<li><strong><code>min_periods = 1</code></strong> to avoid <code>NA</code> values at the head/tail of the time series.</li>
<li><strong><code>center = True</code></strong> to make it match correctly to the time.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Calculate the moving averages</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_smooth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_smooth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="c1"># Plot line chart</span>
<span class="n">small_df</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_flow_smooth&#39;</span><span class="p">,</span> <span class="s1">&#39;out_flow_smooth&#39;</span><span class="p">],</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/gmqF2Vo.png" alt=""></p>
<p>Now calculate the euclidean distance between the in-flow and the out-flow again.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dist</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">pairwise_distances</span><span class="p">([</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;in_flow_smooth&#39;</span><span class="p">]],</span> <span class="p">[</span><span class="n">small_df</span><span class="p">[</span><span class="s1">&#39;out_flow_smooth&#39;</span><span class="p">]],</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&#34;The euclidean distance between in-flow and out-flow of this station is: </span><span class="si">{}</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>The euclidean distance between in-flow and out-flow of this station is: 63.427226939887035
</code></pre>
<h3 id="visualize-the-flows-of-citibikes-over-time">Visualize the flows of citibikes over time</h3>
<p>First, annotate each record as in <strong>Early-July</strong>, <strong>Mid-July</strong>, or <strong>Late-July</strong>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">gen_time_group</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;Early-July&#34;</span>
    <span class="k">elif</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;Mid-July&#34;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&#34;Late-July&#34;</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># Calculate and sort the average flow count for each station</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[[</span><span class="s1">&#39;station id&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;flow_count&#39;</span><span class="p">]]</span> 

<span class="c1"># Create time group</span>
<span class="n">flow</span><span class="p">[</span><span class="s1">&#39;time_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">gen_time_group</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]]</span>

<span class="c1"># Summarise flow count according to time group</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&#34;station id&#34;</span><span class="p">,</span> <span class="s2">&#34;time_group&#34;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;flow_count&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span>

<span class="c1"># Add latitude/logitude columns</span>
<span class="n">flow</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lat_dic</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]]</span>
<span class="n">flow</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lon_dic</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">flow</span><span class="p">[</span><span class="s1">&#39;station id&#39;</span><span class="p">]]</span>

<span class="n">flow</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }
<pre><code>.dataframe thead th {
    text-align: left;
}

.dataframe tbody tr th {
    vertical-align: top;
}
</code></pre>
<p></style></p>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>station id</th>
      <th>time_group</th>
      <th>flow_count</th>
      <th>latitude</th>
      <th>longitude</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>72</td>
      <td>Early-July</td>
      <td>2369.0</td>
      <td>40.767272</td>
      <td>-73.993929</td>
    </tr>
    <tr>
      <th>1</th>
      <td>72</td>
      <td>Late-July</td>
      <td>2989.0</td>
      <td>40.767272</td>
      <td>-73.993929</td>
    </tr>
    <tr>
      <th>2</th>
      <td>72</td>
      <td>Mid-July</td>
      <td>2683.0</td>
      <td>40.767272</td>
      <td>-73.993929</td>
    </tr>
    <tr>
      <th>3</th>
      <td>79</td>
      <td>Early-July</td>
      <td>1580.0</td>
      <td>40.719116</td>
      <td>-74.006667</td>
    </tr>
    <tr>
      <th>4</th>
      <td>79</td>
      <td>Late-July</td>
      <td>2282.0</td>
      <td>40.719116</td>
      <td>-74.006667</td>
    </tr>
  </tbody>
</table>
</div>
<p><strong>Then plot every popular stations on map.</strong></p>
<p>Note that the size of the station point is calculated as</p>
<p>$$
Size = 2^{flow}
$$</p>
<p>$$
flow = \frac{sum~of~flow~count~in~this~time~period}{1000}
$$</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">plot_stations_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">stns</span><span class="p">,</span> <span class="n">noText</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># determine range to print based on min, max lat and lon of the data</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stns</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stns</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">siz</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">stns</span><span class="p">[</span><span class="s1">&#39;flow_count&#39;</span><span class="p">]]</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># buffer to add to the range</span>
    <span class="n">lat_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
    <span class="n">lat_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin</span>
    <span class="n">lon_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
    <span class="n">lon_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">+</span> <span class="n">margin</span>

    <span class="c1"># create map using BASEMAP</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Basemap</span><span class="p">(</span><span class="n">llcrnrlon</span><span class="o">=</span><span class="n">lon_min</span><span class="p">,</span>
                <span class="n">llcrnrlat</span><span class="o">=</span><span class="n">lat_min</span><span class="p">,</span>
                <span class="n">urcrnrlon</span><span class="o">=</span><span class="n">lon_max</span><span class="p">,</span>
                <span class="n">urcrnrlat</span><span class="o">=</span><span class="n">lat_max</span><span class="p">,</span>
                <span class="n">lat_0</span><span class="o">=</span><span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">lon_0</span><span class="o">=</span><span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;lcc&#39;</span><span class="p">,</span>
                <span class="n">resolution</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span><span class="p">,)</span>

    <span class="n">m</span><span class="o">.</span><span class="n">drawcoastlines</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">fillcontinents</span><span class="p">(</span><span class="n">lake_color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">drawmapboundary</span><span class="p">(</span><span class="n">fill_color</span><span class="o">=</span><span class="s1">&#39;aqua&#39;</span><span class="p">)</span>
    <span class="n">m</span><span class="o">.</span><span class="n">drawrivers</span><span class="p">()</span>

    <span class="c1"># convert lat and lon to map projection coordinates</span>
    <span class="n">lons</span><span class="p">,</span> <span class="n">lats</span> <span class="o">=</span> <span class="n">m</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">)</span>

    <span class="c1"># plot points as red dots</span>
    <span class="k">if</span> <span class="n">noText</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">siz</span><span class="p">)</span>
    
    <span class="c1"># annotate popular stations</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">siz</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">siz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">6</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">lons</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">text</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pop_flow</span> <span class="o">=</span> <span class="n">flow</span><span class="p">[</span><span class="n">flow</span><span class="p">[</span><span class="s1">&#39;flow_count&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;All Stations&#34;</span><span class="p">)</span>
<span class="n">plot_stations_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">flow</span><span class="p">,</span> <span class="n">noText</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Popular Stations in Early July&#34;</span><span class="p">)</span>
<span class="n">plot_stations_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">pop_flow</span><span class="p">[</span><span class="n">pop_flow</span><span class="p">[</span><span class="s1">&#39;time_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;Early-July&#34;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Popular Stations in Mid July&#34;</span><span class="p">)</span>
<span class="n">plot_stations_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">pop_flow</span><span class="p">[</span><span class="n">pop_flow</span><span class="p">[</span><span class="s1">&#39;time_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;Mid-July&#34;</span><span class="p">])</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&#34;Popular Stations in Late July&#34;</span><span class="p">)</span>
<span class="n">plot_stations_map</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">pop_flow</span><span class="p">[</span><span class="n">pop_flow</span><span class="p">[</span><span class="s1">&#39;time_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;Late-July&#34;</span><span class="p">])</span>
</code></pre></td></tr></table>
</div>
</div><p><img src="https://i.imgur.com/bsRhWZH.png" alt=""></p>
<p>Here are my observations:</p>
<ol>
<li>Few people ride citibikes in Jersey City and Brooklyn, that is, <strong>the main flow of citibike concentrates in Manhattan</strong>.</li>
<li>The poular stations in Brooklyn are nearly the same across the whole month.</li>
<li>Although the top popular regions (locations with large red circle) look similar, <strong>the top popular stations are not the same across the whole month</strong>. (Check station id carefully you&rsquo;ll see they are not the same.)</li>
<li>For popular regions, more and more people ride citibikes in Mid July and Late July.</li>
</ol>
    
	</div>
  <footer class="article-footer clearfix">
  

<div class="article-tags">
  <span></span>
  
  <a href="https://binnz.github.io/tags/data-mining">Data-Mining</a>
  
  <a href="https://binnz.github.io/tags/python">Python</a>
  
</div>





<div class="article-categories">
  <span></span>
  
  <a class="article-category-link" href="https://binnz.github.io/categories/programming">Programming</a>
  
</div>



  <div class="article-share" id="share">
    <div data-url="https://binnz.github.io/post/2017-12-20-data-preprocessing/" data-title="Data Preprocessing and Exploring the New York City Bike Dataset" data-tsina="" class="share clearfix">
    </div>
  </div>
</footer>

	</article>
  


<section class="comment">
<div id="disqus_thread"></div>
</section>
<script>
  <!-- detect whether Disuqs can load -->
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '//disqus.com/next/config.json?' + new Date().getTime(), true);
  xhr.timeout = 3000; 

  xhr.onload = function() { 


var disqus_config = function () {
this.page.url = "https://binnz.github.io/post/2017-12-20-data-preprocessing/";
this.page.identifier = "https://binnz.github.io/post/2017-12-20-data-preprocessing/";
};
(function() { 
var d = document, s = d.createElement('script');

s.src = '//disc.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
}
  xhr.ontimeout = function() {
  <!-- cannot load Disqus, skip it. -->
  return;
}
xhr.send(null);
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


</div>

    <div class="openaside"><a class="navbutton" href="#" title="Show SideBar"></a></div>
<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide SideBar"></a></div>
<aside class="clearfix">
  

<div class="categorieslist">
  <p class="asidetitle">Categories</p>
  <ul>
    
    <li><a href="https://binnz.github.io/categories/install" title="install">install<sup>2</sup></a></li>
    
    <li><a href="https://binnz.github.io/categories/life" title="life">life<sup>1</sup></a></li>
    
    <li><a href="https://binnz.github.io/categories/notes" title="notes">notes<sup>50</sup></a></li>
    
    <li><a href="https://binnz.github.io/categories/programming" title="programming">programming<sup>25</sup></a></li>
    
    <li><a href="https://binnz.github.io/categories/projects" title="projects">projects<sup>2</sup></a></li>
    
    <li><a href="https://binnz.github.io/categories/publications" title="publications">publications<sup>1</sup></a></li>
    
  </ul>
</div>



  

<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
      
			<li><a href="https://binnz.github.io/tags/ANDROID" title="android">android<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/APACHE-PIG" title="apache-pig">apache-pig<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/ASSOCIATION-ANALYSIS" title="association-analysis">association-analysis<sup>9</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/BEER" title="beer">beer<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/CLASSIFICATION" title="classification">classification<sup>9</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/CLUSTERING" title="clustering">clustering<sup>19</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/CONFERENCE" title="conference">conference<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/DATA-MINING" title="data-mining">data-mining<sup>64</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/DATA-SCIENCE" title="data-science">data-science<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/DATABASE" title="database">database<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/DEEP-LEARNING" title="deep-learning">deep-learning<sup>2</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/ELASTICSEARCH" title="elasticsearch">elasticsearch<sup>2</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/GRAPH" title="graph">graph<sup>12</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/HADOOP" title="hadoop">hadoop<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/INFORMATION-RETRIEVAL" title="information-retrieval">information-retrieval<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/JAVA" title="java">java<sup>5</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/MACHINE-LEARNING" title="machine-learning">machine-learning<sup>5</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/NEURAL-NETWORK" title="neural-network">neural-network<sup>2</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/NLP" title="nlp">nlp<sup>4</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/NLTK" title="nltk">nltk<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/PYTHON" title="python">python<sup>15</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/R" title="r">r<sup>4</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/RELATION-ALGEBRA" title="relation-algebra">relation-algebra<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/SCIKIT-LEARN" title="scikit-learn">scikit-learn<sup>5</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/SPARK" title="spark">spark<sup>9</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/SQL" title="sql">sql<sup>3</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/STATISTICS" title="statistics">statistics<sup>5</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/STREAMING" title="streaming">streaming<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/TIME-SERIES" title="time-series">time-series<sup>2</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/TRAVEL" title="travel">travel<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/UNIT-TEST" title="unit-test">unit-test<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/VBA" title="vba">vba<sup>1</sup></a></li>
      
			<li><a href="https://binnz.github.io/tags/WINDOWS" title="windows">windows<sup>1</sup></a></li>
      
		</ul>
</div>



  
  <div class="archiveslist">
    <p class="asidetitle">Archives</p>
    <ul class="archive-list">
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2021-06">2021年06月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2020-05">2020年05月</a><span class="archive-list-count">12</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2019-09">2019年09月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-09">2018年09月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-08">2018年08月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-06">2018年06月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-05">2018年05月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-04">2018年04月</a><span class="archive-list-count">5</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-03">2018年03月</a><span class="archive-list-count">5</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2018-01">2018年01月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-12">2017年12月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-11">2017年11月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-10">2017年10月</a><span class="archive-list-count">1</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-09">2017年09月</a><span class="archive-list-count">10</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-08">2017年08月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-07">2017年07月</a><span class="archive-list-count">4</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-05">2017年05月</a><span class="archive-list-count">3</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-04">2017年04月</a><span class="archive-list-count">2</span>
      </li>
      
      
      <li class="archive-list-item">
        <a class="archive-list-link" href="https://binnz.github.io/post/#2017-03">2017年03月</a><span class="archive-list-count">20</span>
      </li>
      
    </ul>

  </div>


  

<div class="tagcloudlist">
  <p class="asidetitle">Tags Cloud</p>
  <div class="tagcloudlist clearfix">
    
    <a href="https://binnz.github.io/tags/android" style="font-size: 12px;">android</a>
    
    <a href="https://binnz.github.io/tags/apache-pig" style="font-size: 12px;">apache-pig</a>
    
    <a href="https://binnz.github.io/tags/association-analysis" style="font-size: 12px;">association-analysis</a>
    
    <a href="https://binnz.github.io/tags/beer" style="font-size: 12px;">beer</a>
    
    <a href="https://binnz.github.io/tags/classification" style="font-size: 12px;">classification</a>
    
    <a href="https://binnz.github.io/tags/clustering" style="font-size: 12px;">clustering</a>
    
    <a href="https://binnz.github.io/tags/conference" style="font-size: 12px;">conference</a>
    
    <a href="https://binnz.github.io/tags/data-mining" style="font-size: 12px;">data-mining</a>
    
    <a href="https://binnz.github.io/tags/data-science" style="font-size: 12px;">data-science</a>
    
    <a href="https://binnz.github.io/tags/database" style="font-size: 12px;">database</a>
    
    <a href="https://binnz.github.io/tags/deep-learning" style="font-size: 12px;">deep-learning</a>
    
    <a href="https://binnz.github.io/tags/elasticsearch" style="font-size: 12px;">elasticsearch</a>
    
    <a href="https://binnz.github.io/tags/graph" style="font-size: 12px;">graph</a>
    
    <a href="https://binnz.github.io/tags/hadoop" style="font-size: 12px;">hadoop</a>
    
    <a href="https://binnz.github.io/tags/information-retrieval" style="font-size: 12px;">information-retrieval</a>
    
    <a href="https://binnz.github.io/tags/java" style="font-size: 12px;">java</a>
    
    <a href="https://binnz.github.io/tags/machine-learning" style="font-size: 12px;">machine-learning</a>
    
    <a href="https://binnz.github.io/tags/neural-network" style="font-size: 12px;">neural-network</a>
    
    <a href="https://binnz.github.io/tags/nlp" style="font-size: 12px;">nlp</a>
    
    <a href="https://binnz.github.io/tags/nltk" style="font-size: 12px;">nltk</a>
    
    <a href="https://binnz.github.io/tags/python" style="font-size: 12px;">python</a>
    
    <a href="https://binnz.github.io/tags/r" style="font-size: 12px;">r</a>
    
    <a href="https://binnz.github.io/tags/relation-algebra" style="font-size: 12px;">relation-algebra</a>
    
    <a href="https://binnz.github.io/tags/scikit-learn" style="font-size: 12px;">scikit-learn</a>
    
    <a href="https://binnz.github.io/tags/spark" style="font-size: 12px;">spark</a>
    
    <a href="https://binnz.github.io/tags/sql" style="font-size: 12px;">sql</a>
    
    <a href="https://binnz.github.io/tags/statistics" style="font-size: 12px;">statistics</a>
    
    <a href="https://binnz.github.io/tags/streaming" style="font-size: 12px;">streaming</a>
    
    <a href="https://binnz.github.io/tags/time-series" style="font-size: 12px;">time-series</a>
    
    <a href="https://binnz.github.io/tags/travel" style="font-size: 12px;">travel</a>
    
    <a href="https://binnz.github.io/tags/unit-test" style="font-size: 12px;">unit-test</a>
    
    <a href="https://binnz.github.io/tags/vba" style="font-size: 12px;">vba</a>
    
    <a href="https://binnz.github.io/tags/windows" style="font-size: 12px;">windows</a>
    
  </div>
</div>



  

</aside>
</div>

  </div>
  <footer><div id="footer" >
  <div class="line">
    <span></span>
    
    <div style='background:no-repeat url("https://binnz.github.io/img/US-MT-EPS-02-6001.png") left top;-webkit-background-size:6.875em 6.875em;-moz-background-size:6.875em 6.875em;background-size:6.875em 6.875em;' class="author" ></div>
  </div>
  <section class="info">
    <p>hehe</p>
  </section>
  <div class="social-font clearfix">
    <a href='http://weibo.com/coderzh' target="_blank" title="weibo"></a>
    <a href='https://twitter.com/coderzh' target="_blank" title="twitter"></a>
    <a href='https://github.com/binnz' target="_blank" class="icon-github" title="github"></a>
    <a href='https://www.facebook.com/coderzh' target="_blank" title="facebook"></a>
    <a href='https://www.linkedin.com/coderzh' target="_blank" title="linkedin"></a>
  </div>
  <p class="copyright">Powered by <a href="http://gohugo.io" target="_blank" title="hugo">hugo</a> and Theme by <a href="https://github.com/coderzh/hugo-pacman-theme" target="_blank" title="hugo-pacman-theme">hugo-pacman-theme</a> © 2021
    
    <a href="https://binnz.github.io/" title="California Dreaming">California Dreaming</a>
    
  </p>
</div>
</footer>
  <script src="https://binnz.github.io/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
done = false;
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  $('form.search').on('submit', function (event) {
    if (false === done) {
      event.preventDefault();
      var orgVal = $(this).find('#search').val();
      $(this).find('#search').val('site:https:\/\/binnz.github.io\/ ' + orgVal);
      done = true;
      $(this).submit();
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://b.bshare.cn/barCode?site=weixin&url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});
</script>





</body>
</html>
